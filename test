#!/bin/sh

bh="$PWD/bh"
li="$PWD/list"
testdir="/tmp/bh-test-$(date -u +"%F.%T")-$RANDOM"

failcount=0
failtest () {
	echo "FAILURE ($?):" $1
	failcount=$(($failcount + 1))
}

mkdir "$testdir"
cd "$testdir"

$bh init

# Non-existant repo tests
"$bh" add junk:junk
if [ -d junk ]  ; then failtest "Add junk protocol should fail here" ; fi

"$bh" addprot junk
if [ ! -d junk ]  ; then failtest "Adding junk protocol failed"; fi

"$bh" add junk:junk
if [ ! -d junk/junk ] ; then failtest "Junk entry folder added" ; fi
if [ ! -f junk/junk/.entry ] ; then failtest "Junk entry file added" ; fi

echo "Adding standrd protocols"
protocols=(arxiv doi isbn)
bh addprot "${protocols[@]}"
for i in "${protocols[@]}"; do
	if [ ! -d "$i" ]; then failtest "Couldn't add $i protocol"; fi
done

echo "Adding entries:"
time cat $li | xargs $bh add
echo "Return: " $?
tree -a

# Reflow tests
mkdir doi/$($bh enc 10.1103/)
mkdir doi/$($bh enc 10.1103/)/$($bh enc physreva.)

echo "Reflowing entries"
time find . -name .entry -printf %h\\0 | xargs -0 $bh reflow
echo "Return: " $?

tree -a

rm -rf "$testdir"

echo Failures: $failcount
